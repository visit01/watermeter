<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ระบบจดมาตรน้ำอัจฉริยะ — Demo (v2)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
  <style>
    body { background: #f7fbff; }
    .app-header { background: linear-gradient(135deg, #0d6efd 0%, #5aa9ff 100%); color: white; }
    .logo-badge { width: 44px; height: 44px; border-radius: 12px; background: #ffffff22; display: grid; place-items: center; border: 1px solid #ffffff55; }
    .logo-badge svg { width: 26px; height: 26px; }
    .card-lift { border-radius: 16px; box-shadow: 0 10px 24px rgba(13,110,253,.08); }
    .keypad-btn { font-size: 1.4rem; padding: .9rem 0; }
    .keypad-display { font-size: 2rem; letter-spacing: .06em; }
    .table-soft { background: #e9f4ff !important; }
    .measure-accent { font-weight: 700; color: #0d6efd; }
    .qr-box { width: 100%; aspect-ratio: 3/2; background: #000; border-radius: 12px; overflow: hidden; position: relative; }
    .qr-help { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#fff7; font-size:.95rem; }
    .alert-fixed { position: fixed; left: .75rem; right: .75rem; bottom: .75rem; z-index: 1080; }
    .small-muted { color: #6c757d; }
  </style>
</head>
<body>
  <header class="app-header py-3 px-3">
    <div class="d-flex align-items-center gap-3">
      <div class="logo-badge">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2C12 2 5 10 5 14.5C5 18.09 8.134 21 12 21C15.866 21 19 18.09 19 14.5C19 10 12 2 12 2Z"/>
          <path d="M9 15c0 1.657 1.343 3 3 3"/>
        </svg>
      </div>
      <div>
        <div class="small opacity-75">Demo</div>
        <h1 class="h5 mb-0">ระบบจดมาตรน้ำอัจฉริยะ</h1>
      </div>
      <div class="ms-auto"><span class="badge text-bg-light text-primary rounded-pill">Mobile</span></div>
    </div>
  </header>

  <main class="container py-3">
    <div class="card card-lift border-0 mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
          <p class="mb-0 text-secondary">สแกน QR เพื่อเริ่ม (11 หลัก)</p>
          <button id="btnScan" class="btn btn-primary btn-sm">
            <i class="bi bi-qr-code-scan me-1"></i> ผู้ใช้น้ำ
          </button>
        </div>
      </div>
    </div>

    <div id="infoCard" class="card card-lift border-0 mb-3 d-none">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h2 class="h6 mb-0"><i class="bi bi-person-vcard me-2"></i>ข้อมูลผู้ใช้น้ำ</h2>
          <button id="btnOpenRecord" class="btn btn-success btn-sm">
            <i class="bi bi-pencil-square me-1"></i> บันทึกเลขมิเตอร์น้ำ
          </button>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-soft table-bordered align-middle">
            <tbody id="infoTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="usageCard" class="card card-lift border-0 d-none">
      <div class="card-body">
        <h2 class="h6 mb-3"><i class="bi bi-droplet-half me-2"></i>ผลการบันทึกวันนี้</h2>
        <div class="table-responsive">
          <table class="table table-soft table-bordered align-middle">
            <tbody id="usageTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Scan Modal -->
  <div class="modal fade" id="scanModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-camera-video me-2"></i>สแกน QR ผู้ใช้น้ำ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด"></button>
        </div>
        <div class="modal-body">
          <div id="qr-reader" class="qr-box">
            <div class="qr-help">กำลังเตรียมกล้อง…</div>
          </div>
          <div id="scanErrorBox" class="alert alert-danger mt-3 d-none" role="alert">
            <div class="d-flex align-items-start gap-2">
              <i class="bi bi-exclamation-octagon fs-5"></i>
              <div>
                <div class="fw-bold">ไม่สามารถเปิดกล้องได้</div>
                <div id="scanErrorMsg" class="small"></div>
              </div>
            </div>
          </div>

          <div class="input-group mt-3">
            <span class="input-group-text"><i class="bi bi-hash"></i></span>
            <input id="manualMeterId" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="11" class="form-control" placeholder="ป้อนหมายเลขมิเตอร์ (11 หลัก)">
            <button id="btnManualUse" class="btn btn-outline-primary">ใช้ค่านี้</button>
          </div>
          <div class="form-text mt-2 small-muted">
            หากกล้องไม่ทำงาน: ต้องเปิดผ่าน <b>HTTPS</b> หรือ <b>localhost</b> และอนุญาตสิทธิ์กล้องในเบราว์เซอร์
          </div>
        </div>
        <div class="modal-footer">
          <button id="btnStopScan" type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ปิด</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Record Modal -->
  <div class="modal fade" id="recordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-calculator me-2"></i>บันทึกเลขมิเตอร์น้ำ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด"></button>
        </div>
        <div class="modal-body">
          <div class="form-floating">
            <input id="keypadInput" type="text" class="form-control keypad-display" placeholder="0" inputmode="numeric" readonly>
            <label for="keypadInput">เลขมิเตอร์น้ำวันนี้</label>
          </div>
          <div class="row g-2 mt-3">
            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="1">1</button></div>
            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="2">2</button></div>
            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="3">3</button></div>
            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="4">4</button></div>
            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="5">5</button></div>
            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="6">6</button></div>
            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="7">7</button></div>
            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="8">8</button></div>
            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="9">9</button></div>
            <div class="col-4"><button class="btn btn-outline-danger w-100 keypad-btn" data-action="clear"><i class="bi bi-x-circle"></i></button></div>
            <div class="col-4"><button class="btn btn-light w-100 keypad-btn" data-key="0">0</button></div>
            <div class="col-4"><button class="btn btn-outline-secondary w-100 keypad-btn" data-action="back"><i class="bi bi-backspace"></i></button></div>
          </div>
        </div>
        <div class="modal-footer d-grid gap-2">
          <button id="btnRecord" class="btn btn-primary btn-lg"><i class="bi bi-check2-circle me-1"></i> RECORD</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-question-circle me-2"></i>ยืนยันการบันทึก</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด"></button>
        </div>
        <div class="modal-body">ต้องการบันทึกเลขมิเตอร์น้ำนี้ใช่หรือไม่?</div>
        <div class="modal-footer">
          <button id="btnCancelConfirm" type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ยกเลิก</button>
          <button id="btnOkConfirm" type="button" class="btn btn-primary">ตกลง</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toastArea" class="alert-fixed"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Utils
    const formatDate = (d) => {
      const pad = (n)=> String(n).padStart(2, '0');
      const dd = pad(d.getDate());
      const mm = pad(d.getMonth()+1);
      const yy = String(d.getFullYear()).slice(-2);
      const hh = pad(d.getHours());
      const min = pad(d.getMinutes());
      return `${dd}/${mm}/${yy} ${hh}:${min}`;
    };
    const addHours = (date, h) => new Date(date.getTime() + h*3600*1000);
    const monthAgoSameDay = (date) => {
      const d = new Date(date);
      const m = d.getMonth();
      d.setMonth(m - 1);
      if (d.getMonth() === m) d.setDate(0);
      return d;
    };
    const isSecure = () => location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';

    // State
    let meterId = null;
    const PREV_READING = 1562;
    let html5QrCode = null;
    let isScanning = false;
    let preferredCameraId = null;

    // Elements
    const infoCard = document.getElementById('infoCard');
    const infoTableBody = document.getElementById('infoTableBody');
    const usageCard = document.getElementById('usageCard');
    const usageTableBody = document.getElementById('usageTableBody');
    const scanModalEl = document.getElementById('scanModal');
    const scanModal = new bootstrap.Modal(scanModalEl);
    const recordModalEl = document.getElementById('recordModal');
    const recordModal = new bootstrap.Modal(recordModalEl);
    const confirmModalEl = document.getElementById('confirmModal');
    const confirmModal = new bootstrap.Modal(confirmModalEl);
    const btnScan = document.getElementById('btnScan');
    const btnOpenRecord = document.getElementById('btnOpenRecord');
    const keypadInput = document.getElementById('keypadInput');
    const manualMeterIdInput = document.getElementById('manualMeterId');
    const btnManualUse = document.getElementById('btnManualUse');
    const btnStopScan = document.getElementById('btnStopScan');
    const toastArea = document.getElementById('toastArea');
    const scanErrorBox = document.getElementById('scanErrorBox');
    const scanErrorMsg = document.getElementById('scanErrorMsg');

    function toast(msg, type='warning') {
      const id = 't'+Date.now();
      const el = document.createElement('div');
      el.id = id;
      el.className = `alert alert-${type}`;
      el.innerHTML = `<div class="d-flex align-items-center"><i class="bi ${type==='danger'?'bi-exclamation-octagon':'bi-info-circle'} me-2"></i>${msg}</div>`;
      toastArea.appendChild(el);
      setTimeout(()=> { el.remove(); }, 5500);
    }

    // Camera helpers
    async function pickBackCamera() {
      try {
        const devices = await Html5Qrcode.getCameras();
        if (!devices || devices.length === 0) return null;
        const back = devices.find(d => /back|rear|environment/i.test(d.label));
        return back ? back.id : devices[0].id;
      } catch (e) {
        return null;
      }
    }

    function explainMediaError(err) {
      // Map common getUserMedia errors to Thai explanations
      const name = err?.name || '';
      const msg = err?.message || String(err);
      let hint = '';
      switch (name) {
        case 'NotAllowedError':
        case 'SecurityError':
          hint = 'ไม่ได้รับอนุญาตให้ใช้กล้อง กรุณาอนุญาตการเข้าถึงกล้องในเบราว์เซอร์/ระบบ แล้วรีเฟรชหน้าเว็บ'; break;
        case 'NotFoundError':
          hint = 'ไม่พบอุปกรณ์กล้อง กรุณาเชื่อมต่อกล้อง หรือใช้มือถือที่มีกล้อง'; break;
        case 'NotReadableError':
          hint = 'ไม่สามารถเข้าถึงกล้อง อาจถูกใช้งานโดยแอปอื่นอยู่ ปิดแอปที่ใช้กล้องแล้วลองใหม่'; break;
        case 'OverconstrainedError':
          hint = 'ข้อกำหนดกล้องไม่ตรงกับอุปกรณ์ ลองสลับไปใช้กล้องตัวอื่น'; break;
        case 'NotSupportedError':
          hint = 'เบราว์เซอร์ไม่รองรับการใช้งานกล้องสำหรับบริบทนี้ ลองอัปเดตเบราว์เซอร์หรือเปลี่ยนเครื่องมือ'; break;
        default:
          hint = isSecure()
            ? 'ลองรีเฟรชหน้าเว็บ หรือเปลี่ยนเบราว์เซอร์/อุปกรณ์'
            : 'ต้องเปิดผ่าน HTTPS หรือ localhost เท่านั้น';
      }
      return { code: name || 'UnknownError', message: msg, hint };
    }

    async function startScanner() {
      const qrRegion = document.getElementById('qr-reader');
      qrRegion.innerHTML = '<div class="qr-help">กำลังเปิดกล้อง…</div>';
      scanErrorBox.classList.add('d-none');
      scanErrorMsg.textContent = '';

      if (!isSecure()) {
        const { code, hint } = { code: 'InsecureContext', hint: 'ต้องเปิดผ่าน HTTPS หรือ localhost เพื่อใช้กล้องค่ะ' };
        scanErrorBox.classList.remove('d-none');
        scanErrorMsg.innerHTML = `<b>Code:</b> ${code} — ${hint}`;
        return;
      }

      try {
        if (!preferredCameraId) preferredCameraId = await pickBackCamera();
        html5QrCode = new Html5Qrcode("qr-reader", { verbose: false });
        isScanning = true;
        const config = { fps: 10, qrbox: { width: 240, height: 240 } };
        const camConfig = preferredCameraId ? { deviceId: { exact: preferredCameraId } } : { facingMode: "environment" };
        await html5QrCode.start(camConfig, config, onScanSuccess, onScanError);
      } catch (err) {
        const { code, message, hint } = explainMediaError(err);
        scanErrorBox.classList.remove('d-none');
        scanErrorMsg.innerHTML = `<b>Code:</b> ${code}<br><b>Message:</b> ${message}<br><b>Hint:</b> ${hint}`;
        toast('ไม่สามารถเปิดกล้องได้ (' + (code || 'Error') + ')', 'danger');
      }
    }

    async function stopScanner() {
      if (html5QrCode && isScanning) {
        try { await html5QrCode.stop(); } catch {}
        try { await html5QrCode.clear(); } catch {}
      }
      isScanning = false;
    }

    function onScanSuccess(decodedText) {
      const onlyDigits = decodedText.replace(/\D/g, "");
      if (onlyDigits.length === 11) {
        meterId = onlyDigits;
        stopScanner();
        bootstrap.Modal.getInstance(scanModalEl)?.hide();
        fillInfoTable();
      }
    }
    function onScanError(err) {
      // keep scanner alive; optionally log errors
    }

    // Fill tables
    function fillInfoTable() {
      if (!meterId) return;
      const now = new Date();
      const prev = addHours(monthAgoSameDay(now), 2);
      infoTableBody.innerHTML = `
        <tr><th class="w-50">หมายเลขมิเตอร์น้ำ</th><td>${meterId}</td></tr>
        <tr><th>ผู้ใช้น้ำ</th><td>อ.ทอง หลอมประโคน</td></tr>
        <tr><th>ที่อยู่</th><td>193/8 หมู่ที่ 9 ตำบลเสม็ด อำเภอเมืองบุรีรัมย์ จ.บุรีรัมย์ 31000</td></tr>
        <tr><th>วันที่จดมิเตอร์น้ำก่อนหน้า</th><td>${formatDate(prev)}</td></tr>
        <tr><th>เลขมิเตอร์น้ำก่อนหน้า</th><td>${PREV_READING}</td></tr>
        <tr><th>ผู้จดมิเตอร์น้ำ</th><td>นางสาว พรทิพย์ รุ่งเรืองดี</td></tr>
      `;
      infoCard.classList.remove('d-none');
      usageCard.classList.add('d-none');
    }

    function fillUsageTable(currentReading) {
      const now = new Date();
      const used = currentReading - PREV_READING;
      usageTableBody.innerHTML = `
        <tr><th class="w-50">วันที่จดมิเตอร์น้ำ</th><td>${formatDate(now)}</td></tr>
        <tr><th>เลขมิเตอร์น้ำวันนี้</th><td>${currentReading}</td></tr>
        <tr><th class="measure-accent">หน่วยใช้น้ำ</th><td class="measure-accent">${used}</td></tr>
      `;
      usageCard.classList.remove('d-none');
    }

    // Keypad
    function appendDigit(d) {
      const cur = keypadInput.value || "";
      keypadInput.value = (cur === "0") ? String(d) : (cur + String(d));
    }
    function clearInput() { keypadInput.value = ""; }
    function backspace() { keypadInput.value = (keypadInput.value || "").slice(0, -1); }

    document.querySelectorAll('.keypad-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const key = btn.dataset.key;
        const action = btn.dataset.action;
        if (key) appendDigit(key);
        else if (action === 'clear') clearInput();
        else if (action === 'back') backspace();
      });
    });

    document.getElementById('btnRecord').addEventListener('click', () => {
      const v = parseInt(keypadInput.value, 10);
      if (isNaN(v)) { alert('กรุณาป้อนเลขมิเตอร์น้ำ'); return; }
      const diff = v - PREV_READING;
      if (diff < 50) { alert('กรุณาเช็คข้อมูลอีกครั้ง!'); return; }
      confirmModal.show();
    });
    document.getElementById('btnCancelConfirm').addEventListener('click', clearInput);
    document.getElementById('btnOkConfirm').addEventListener('click', () => {
      const v = parseInt(keypadInput.value, 10);
      confirmModal.hide();
      recordModal.hide();
      if (!isNaN(v)) fillUsageTable(v);
    });

    // Openers
    btnScan.addEventListener('click', async () => {
      manualMeterIdInput.value = "";
      scanModal.show();
    });
    btnStopScan.addEventListener('click', () => stopScanner());
    btnManualUse.addEventListener('click', () => {
      const onlyDigits = manualMeterIdInput.value.replace(/\D/g, "");
      if (onlyDigits.length !== 11) { alert('กรุณาป้อนหมายเลข 11 หลัก'); return; }
      meterId = onlyDigits;
      stopScanner(); scanModal.hide(); fillInfoTable();
    });
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'btnOpenRecord') {
        if (!meterId) { alert('กรุณาสแกนผู้ใช้น้ำก่อน'); return; }
        clearInput(); recordModal.show();
      }
    });

    scanModalEl.addEventListener('shown.bs.modal', () => { startScanner(); });
    scanModalEl.addEventListener('hidden.bs.modal', () => { stopScanner(); });

    // Initial hide
    infoCard.classList.add('d-none');
    usageCard.classList.add('d-none');
  </script>
</body>
</html>
