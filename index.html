<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ระบบจดมาตรน้ำอัจฉริยะ - Demo</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode" defer></script>
  <style>
    body { background: #f5f7fb; }
    header.navbar { background: linear-gradient(90deg, #0d6efd 0%, #4e9bff 100%); }
    .brand-logo {
      width: 38px; height: 38px; border-radius: 50%;
      background: white; display: inline-flex; align-items: center; justify-content: center;
      font-weight: 800; color: #0d6efd;
    }
    .card { border-radius: 1rem; box-shadow: 0 8px 24px rgba(13,110,253,0.08); }
    .keypad .btn { font-size: 1.6rem; padding: 1rem 0; border-radius: 0.8rem; }
    .display-input { font-size: 2rem; letter-spacing: 0.1rem; text-align: right; }
    .table td, .table th { vertical-align: middle; }
    .qr-frame { border: 2px dashed #0d6efd; border-radius: 1rem; overflow: hidden; }
    .badge-pill { border-radius: 50rem; }
    @media (min-width: 576px) { .container-narrow { max-width: 560px; } }
    @media (min-width: 992px) { .container-narrow { max-width: 700px; } }
  </style>
</head>
<body>
  <!-- Top bar -->
  <header class="navbar navbar-dark px-3 py-2 mb-3">
    <div class="d-flex align-items-center gap-2">
      <div class="brand-logo">WM</div>
      <div class="text-white">
        <div class="fw-bold">Water Meter</div>
        <small class="opacity-75">Smart Reading Demo</small>
      </div>
    </div>
    <div class="ms-auto">
      <span class="badge bg-light text-primary fw-semibold badge-pill"><i class="bi bi-phone"></i> Mobile Demo</span>
    </div>
  </header>

  <main class="container container-narrow">
    <div class="card mb-3">
      <div class="card-body">
        <h1 class="h4 mb-2 d-flex align-items-center gap-2">
          <i class="bi bi-droplet-half text-primary"></i>
          ระบบจดมาตรน้ำอัจฉริยะ
        </h1>
        <p class="text-secondary mb-3">สแกน QR ของมิเตอร์เพื่อเริ่ม และบันทึกเลขมิเตอร์วันนี้ผ่านปุ่มตัวเลข</p>
        <div class="d-grid gap-2">
          <button id="btnScan" class="btn btn-primary btn-lg">
            <i class="bi bi-qr-code-scan me-1"></i> จดมาตรน้ำใหม่ (สแกน QR)
          </button>
          <button id="btnNew" class="btn btn-outline-primary btn-lg">
            <i class="bi bi-plus-circle me-1"></i> NEW
          </button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header bg-white">
        <div class="d-flex align-items-center">
          <i class="bi bi-table me-2 text-primary"></i>
          <span class="fw-semibold">ข้อมูลล่าสุด</span>
          <span id="statusBadge" class="badge ms-auto bg-secondary">ยังไม่สแกน</span>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <tbody>
              <tr><th style="width: 40%">หมายเลขมิเตอร์น้ำ</th><td id="meterNo">-</td></tr>
              <tr><th>วันที่จดมิเตอร์น้ำก่อนหน้า</th><td id="prevDate">-</td></tr>
              <tr><th>เลขมิเตอร์น้ำก่อนหน้า</th><td id="prevReading">-</td></tr>
              <tr><th>ผู้จดมิเตอร์น้ำ</th><td id="readerName">-</td></tr>
              <tr><th>วันที่จดมิเตอร์น้ำ</th><td id="todayDate">-</td></tr>
              <tr><th>เลขมิเตอร์น้ำวันนี้</th><td id="todayReading">-</td></tr>
              <tr><th>หน่วยใช้น้ำ</th><td id="usage">-</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal: QR Scan -->
  <div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-qr-code-scan me-2 text-primary"></i>สแกน QR มิเตอร์</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2 small text-secondary">QR จะต้องเป็นตัวเลข 11 หลัก</div>
          <div id="qrReader" class="qr-frame"></div>
          <div class="mt-3">
            <label class="form-label small text-secondary">กรณีไม่มีกล้อง: ป้อนหมายเลขเอง</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-hash"></i></span>
              <input type="text" id="manualMeter" class="form-control" placeholder="ตัวเลข 11 หลัก" inputmode="numeric" maxlength="11">
              <button class="btn btn-outline-primary" id="btnManualSet">ตั้งค่า</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Keypad (NEW) -->
  <div class="modal fade" id="keypadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-123 me-2 text-primary"></i>กรอกเลขมิเตอร์วันนี้</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input id="displayInput" class="form-control display-input" type="text" placeholder="0" inputmode="numeric" readonly>
          </div>

          <div class="keypad row g-2">
            <div class="col-4"><button class="btn btn-light w-100" data-key="1">1</button></div>
            <div class="col-4"><button class="btn btn-light w-100" data-key="2">2</button></div>
            <div class="col-4"><button class="btn btn-light w-100" data-key="3">3</button></div>
            <div class="col-4"><button class="btn btn-light w-100" data-key="4">4</button></div>
            <div class="col-4"><button class="btn btn-light w-100" data-key="5">5</button></div>
            <div class="col-4"><button class="btn btn-light w-100" data-key="6">6</button></div>
            <div class="col-4"><button class="btn btn-light w-100" data-key="7">7</button></div>
            <div class="col-4"><button class="btn btn-light w-100" data-key="8">8</button></div>
            <div class="col-4"><button class="btn btn-light w-100" data-key="9">9</button></div>
            <div class="col-4"><button class="btn btn-outline-secondary w-100" data-action="clear"><i class="bi bi-x-circle"></i></button></div>
            <div class="col-4"><button class="btn btn-light w-100" data-key="0">0</button></div>
            <div class="col-4"><button class="btn btn-outline-secondary w-100" data-action="back"><i class="bi bi-backspace"></i></button></div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="btnRecord" class="btn btn-primary btn-lg w-100">
            <i class="bi bi-check2-circle me-1"></i> RECORD
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Confirm Save -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-save2 me-2 text-primary"></i>ยืนยันการบันทึก</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">ต้องการบันทึกข้อมูลใช่หรือไม่?</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" id="btnCancelSave">ยกเลิก</button>
          <button type="button" class="btn btn-primary" id="btnConfirmSave">ตกลง</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS (must load BEFORE custom script) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <!-- Custom Script -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      // Guard: ensure Bootstrap loaded
      if (!window.bootstrap) {
        alert('Bootstrap ยังไม่ถูกโหลด กรุณาเชื่อมต่ออินเทอร์เน็ตและรีเฟรชหน้า');
        return;
      }

      // Constants
      const PREV_READING = 1562;
      const READER_NAME = "นางสาว พรทิพย์ สว่างดี";

      // Elements
      const meterNoEl = document.getElementById('meterNo');
      const prevDateEl = document.getElementById('prevDate');
      const prevReadingEl = document.getElementById('prevReading');
      const readerNameEl = document.getElementById('readerName');
      const todayDateEl = document.getElementById('todayDate');
      const todayReadingEl = document.getElementById('todayReading');
      const usageEl = document.getElementById('usage');
      const statusBadge = document.getElementById('statusBadge');

      const btnScan = document.getElementById('btnScan');
      const btnNew = document.getElementById('btnNew');
      const btnRecord = document.getElementById('btnRecord');

      const displayInput = document.getElementById('displayInput');
      const keypadModal = new bootstrap.Modal(document.getElementById('keypadModal'));
      const qrModalEl = document.getElementById('qrModal');
      const qrModal = new bootstrap.Modal(qrModalEl);
      const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
      const btnCancelSave = document.getElementById('btnCancelSave');
      const btnConfirmSave = document.getElementById('btnConfirmSave');

      const manualMeterInput = document.getElementById('manualMeter');
      const btnManualSet = document.getElementById('btnManualSet');

      let html5QrCode = null;
      let scannedMeter = null; // 11-digit string

      function pad2(n){ return n.toString().padStart(2,'0'); }
      function formatNow(offsetMonth=0){
        const now = new Date();
        const d = new Date(now);
        d.setMonth(d.getMonth() + offsetMonth);
        const dd = pad2(d.getDate());
        const mm = pad2(d.getMonth()+1);
        const yy = d.getFullYear().toString().slice(-2);
        const hh = pad2(d.getHours());
        const mi = pad2(d.getMinutes());
        return `${dd}/${mm}/${yy} ${hh}:${mi}`;
      }

      function updateTableAfterScan(){
        if(!scannedMeter){ return; }
        meterNoEl.textContent = scannedMeter;
        prevDateEl.textContent = formatNow(-1);
        prevReadingEl.textContent = PREV_READING.toString();
        readerNameEl.textContent = READER_NAME;
        statusBadge.className = "badge ms-auto bg-success";
        statusBadge.textContent = "พร้อมบันทึก";
      }

      function setTodayValues(todayReading){
        todayDateEl.textContent = formatNow(0);
        todayReadingEl.textContent = todayReading.toString();
        const usage = todayReading - PREV_READING;
        usageEl.textContent = usage.toString();
      }

      // QR Handlers
      btnScan.addEventListener('click', async () => {
        // Open modal immediately
        qrModal.show();

        // Delay to render modal content before starting camera
        setTimeout(async () => {
          try {
            if (!window.Html5Qrcode) {
              console.warn("html5-qrcode not loaded yet. Use manual input.");
              return;
            }
            if (!html5QrCode) {
              html5QrCode = new Html5Qrcode("qrReader");
            } else {
              try { await html5QrCode.stop(); } catch(e){}
            }

            const cameras = await Html5Qrcode.getCameras().catch(() => []);
            if (!cameras || !cameras.length) {
              console.warn("No camera found. Use manual input.");
              return;
            }
            await html5QrCode.start(
              { facingMode: "environment" },
              { fps: 10, qrbox: 250 },
              (decodedText) => {
                const clean = (decodedText || "").replace(/[^0-9]/g, "");
                if (clean.length === 11) {
                  scannedMeter = clean;
                  html5QrCode.stop().catch(()=>{});
                  qrModal.hide();
                  updateTableAfterScan();
                }
              },
              () => {}
            );

            // Stop camera when modal closed by user
            qrModalEl.addEventListener('hidden.bs.modal', () => {
              if (html5QrCode) { html5QrCode.stop().catch(()=>{}); }
            }, { once: true });

          } catch (e) {
            console.warn("QR init failed:", e);
          }
        }, 250);
      });

      // Manual meter number set (fallback)
      btnManualSet.addEventListener('click', () => {
        const val = (manualMeterInput.value || "").trim().replace(/[^0-9]/g, "");
        if (val.length !== 11) {
          alert("กรุณากรอกตัวเลข 11 หลัก");
          return;
        }
        scannedMeter = val;
        if (html5QrCode) { html5QrCode.stop().catch(()=>{}); }
        qrModal.hide();
        updateTableAfterScan();
      });

      // NEW -> keypad modal
      btnNew.addEventListener('click', () => {
        displayInput.value = "";
        keypadModal.show();
      });

      // Keypad clicks
      document.querySelectorAll('#keypadModal .keypad .btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const key = btn.getAttribute('data-key');
          const action = btn.getAttribute('data-action');
          if (key) {
            if (displayInput.value === "0") displayInput.value = "";
            if (displayInput.value.length < 10) {
              displayInput.value += key;
            }
          } else if (action === 'back') {
            displayInput.value = displayInput.value.slice(0, -1);
          } else if (action === 'clear') {
            displayInput.value = "";
          }
        });
      });

      // RECORD flow
      btnRecord.addEventListener('click', () => {
        const val = parseInt(displayInput.value || "0", 10);
        if (isNaN(val)) { alert("กรุณาป้อนตัวเลข"); return; }
        const diff = val - PREV_READING;
        if (diff < 50) {
          alert("กรุณาเช็คข้อมูลอีกครั้ง!");
          return;
        }
        confirmModal.show();
      });

      // Confirm modal buttons
      btnCancelSave.addEventListener('click', () => {
        displayInput.value = "";
        confirmModal.hide();
      });

      btnConfirmSave.addEventListener('click', () => {
        confirmModal.hide();
        keypadModal.hide();
        const val = parseInt(displayInput.value || "0", 10);
        if (!isNaN(val)) {
          setTodayValues(val);
        }
      });

      // Initial state
      readerNameEl.textContent = READER_NAME;
      prevReadingEl.textContent = "-";
    });
  </script>
</body>
</html>
