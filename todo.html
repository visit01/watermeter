<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Thai:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Noto Sans Thai', 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden;
            /* Prevent body scroll */
        }

        .kanban-board-container {
            -webkit-overflow-scrolling: touch;
        }

        .kanban-board-container::-webkit-scrollbar {
            height: 8px;
        }

        .kanban-board-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .dark .kanban-board-container::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .kanban-board-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark .kanban-board-container::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        .kanban-board-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .dark .kanban-board-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .kanban-column {
            scroll-snap-align: start;
        }

        .task-card {
            touch-action: pan-y;
            border-left-width: 5px;
            border-left-color: transparent;
        }

        /* Priority Colors */
        .task-card.priority-low {
            border-left-color: #34d399;
            /* emerald-400 */
        }

        .task-card.priority-medium {
            border-left-color: #fbbf24;
            /* amber-400 */
        }

        .task-card.priority-high {
            border-left-color: #f87171;
            /* red-400 */
        }

        .task-card.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }

        .kanban-column.drag-over {
            background-color: #e2e8f0;
        }

        .dark .kanban-column.drag-over {
            background-color: #2d3748;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Custom radio button styles */
        .priority-radio:checked+label {
            border-color: #3b82f6;
            /* blue-500 */
            background-color: #eff6ff;
            /* blue-50 */
        }

        .dark .priority-radio:checked+label {
            border-color: #60a5fa;
            /* blue-400 */
            background-color: #1e3a8a;
            /* blue-900 */
        }

        /* Styles for "Done" tasks */
        .task-card.is-done {
            opacity: 0.7;
        }

        .task-card.is-done .task-text {
            text-decoration: line-through;
            color: #64748b;
            /* slate-500 */
        }

        .dark .task-card.is-done .task-text {
            color: #94a3b8;
            /* slate-400 */
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex flex-col h-screen">

    <!-- Header -->
    <header class="w-full max-w-5xl mx-auto p-4 md:px-6">
        <div class="flex justify-between items-center mb-4">
            <h1 class="flex items-center gap-2 text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">
                <i data-lucide="layout-dashboard"></i>
                <span>Kanban Board</span>
            </h1>
            <div id="user-info" class="text-xs text-gray-400 dark:text-gray-500"></div>
        </div>
        <!-- Add Task Form -->
        <form id="task-form" class="space-y-3">
            <div class="flex gap-3">
                <input type="text" id="task-input" placeholder="เพิ่มงานใหม่..."
                    class="flex-grow bg-white dark:bg-gray-700 border-2 border-gray-300 dark:border-gray-600 focus:border-blue-500 focus:ring-0 rounded-lg px-4 py-2 text-gray-800 dark:text-gray-200 placeholder-gray-400 transition duration-300">
                <button type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 flex items-center justify-center gap-2">
                    <i data-lucide="plus" class="h-5 w-5"></i>
                    <span class="hidden sm:inline">เพิ่ม</span>
                </button>
            </div>
        </form>
    </header>

    <!-- Loading Spinner -->
    <div id="loader" class="flex-grow flex items-center justify-center">
        <div class="loading-spinner"></div>
    </div>

    <!-- Kanban Board -->
    <main id="kanban-board" class="kanban-board-container flex-grow flex flex-col md:flex-row gap-4 overflow-y-auto md:overflow-x-auto p-4 md:px-6 hidden md:scroll-snap-x md:scroll-snap-mandatory">
        <div id="todo-col" data-status="todo"
            class="kanban-column bg-blue-200/50 dark:bg-blue-900/20 w-full md:w-72 lg:w-80 flex-shrink-0 rounded-xl shadow-lg">
            <h2
                class="font-bold text-lg p-4 border-b border-blue-200 dark:border-blue-800 text-gray-900 dark:text-white flex items-center gap-2">
                <i data-lucide="clipboard-list" class="h-5 w-5 text-blue-500"></i><span>สิ่งที่ต้องทำ</span></h2>
            <ul class="task-list p-4 space-y-3 h-full overflow-y-auto"></ul>
        </div>
        <div id="inprogress-col" data-status="inprogress"
            class="kanban-column bg-yellow-200/50 dark:bg-yellow-900/20 w-full md:w-72 lg:w-80 flex-shrink-0 rounded-xl shadow-lg">
            <h2
                class="font-bold text-lg p-4 border-b border-yellow-200 dark:border-yellow-800 text-gray-900 dark:text-white flex items-center gap-2">
                <i data-lucide="loader-2" class="h-5 w-5 text-yellow-500 animate-spin"
                    style="animation-duration: 3s;"></i><span>กำลังทำ</span></h2>
            <ul class="task-list p-4 space-y-3 h-full overflow-y-auto"></ul>
        </div>
        <div id="done-col" data-status="done"
            class="kanban-column bg-green-200/50 dark:bg-green-900/20 w-full md:w-72 lg:w-80 flex-shrink-0 rounded-xl shadow-lg">
            <h2
                class="font-bold text-lg p-4 border-b border-green-200 dark:border-green-800 text-gray-900 dark:text-white flex items-center gap-2">
                <i data-lucide="clipboard-check" class="h-5 w-5 text-green-500"></i><span>เสร็จแล้ว</span></h2>
            <ul class="task-list p-4 space-y-3 h-full overflow-y-auto"></ul>
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2 flex items-center gap-2"><i
                    data-lucide="alert-triangle" class="text-red-500"></i>ยืนยันการลบ</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-6">คุณแน่ใจหรือไม่ว่าต้องการลบงานนี้?</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-delete-btn"
                    class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 flex items-center gap-2"><i
                        data-lucide="x" class="h-4 w-4"></i>ยกเลิก</button>
                <button id="confirm-delete-btn"
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2"><i
                        data-lucide="check" class="h-4 w-4"></i>ยืนยัน</button>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2"><i
                    data-lucide="file-pen-line" class="text-blue-500"></i>แก้ไขงาน</h3>
            <div class="space-y-4">
                <div>
                    <label for="edit-task-input"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ชื่องาน</label>
                    <input type="text" id="edit-task-input"
                        class="w-full bg-gray-100 dark:bg-gray-700 border-2 border-gray-300 dark:border-gray-600 focus:border-blue-500 focus:ring-0 rounded-lg px-3 py-2 text-gray-800 dark:text-gray-200">
                </div>
                <div class="flex items-center justify-start gap-3">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">ความสำคัญ:</span>
                    <div>
                        <input type="radio" name="edit-priority" id="edit-priority-low" value="low"
                            class="sr-only priority-radio">
                        <label for="edit-priority-low"
                            class="px-3 py-1 text-sm border-2 rounded-full cursor-pointer transition-colors border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 flex items-center gap-1.5"><i
                                data-lucide="arrow-down" class="h-4 w-4 text-green-500"></i>ต่ำ</label>
                    </div>
                    <div>
                        <input type="radio" name="edit-priority" id="edit-priority-medium" value="medium"
                            class="sr-only priority-radio">
                        <label for="edit-priority-medium"
                            class="px-3 py-1 text-sm border-2 rounded-full cursor-pointer transition-colors border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 flex items-center gap-1.5"><i
                                data-lucide="minus" class="h-4 w-4 text-yellow-500"></i>กลาง</label>
                    </div>
                    <div>
                        <input type="radio" name="edit-priority" id="edit-priority-high" value="high"
                            class="sr-only priority-radio">
                        <label for="edit-priority-high"
                            class="px-3 py-1 text-sm border-2 rounded-full cursor-pointer transition-colors border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 flex items-center gap-1.5"><i
                                data-lucide="arrow-up" class="h-4 w-4 text-red-500"></i>สูง</label>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-edit-btn"
                    class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 flex items-center gap-2"><i
                        data-lucide="x" class="h-4 w-4"></i>ยกเลิก</button>
                <button id="save-edit-btn"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"><i
                        data-lucide="save" class="h-4 w-4"></i>บันทึก</button>
            </div>
        </div>
    </div>

    <!-- Date Picker Modal -->
    <div id="date-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2"><i
                    data-lucide="calendar-clock" class="text-blue-500"></i>กำหนดวันที่และเวลา</h3>
            <div class="space-y-4">
                <div>
                    <label for="due-date-input"
                        class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">เลือกวันที่และเวลา</label>
                    <input type="datetime-local" id="due-date-input"
                        class="w-full bg-gray-100 dark:bg-gray-700 border-2 border-gray-300 dark:border-gray-600 focus:border-blue-500 focus:ring-0 rounded-lg px-3 py-2 text-gray-800 dark:text-gray-200">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancel-date-btn"
                    class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 flex items-center gap-2"><i
                        data-lucide="x" class="h-4 w-4"></i>ยกเลิก</button>
                <button id="save-date-btn"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"><i
                        data-lucide="save" class="h-4 w-4"></i>บันทึก</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = 'my-kanban-app';
        const firebaseConfig = {
            apiKey: "AIzaSyDbuFzOEToItwIeCOOf_Q06p6XukWvw-Ds",
            authDomain: "todo-abeae.firebaseapp.com",
            projectId: "todo-abeae",
            storageBucket: "todo-abeae.firebasestorage.app",
            messagingSenderId: "558946662928",
            appId: "1:558946662928:web:1d239112c222b4f5d4e895",
            measurementId: "G-4MKM41NHXL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // All DOM elements references...
        const taskForm = document.getElementById('task-form');
        const taskInput = document.getElementById('task-input');
        const loader = document.getElementById('loader');
        const kanbanBoard = document.getElementById('kanban-board');
        const userInfo = document.getElementById('user-info');
        const columns = document.querySelectorAll('.kanban-column');
        const taskLists = document.querySelectorAll('.task-list');
        // Modals
        const deleteModal = document.getElementById('delete-modal');
        const editModal = document.getElementById('edit-modal');
        const dateModal = document.getElementById('date-modal');
        // Modal buttons
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const cancelDateBtn = document.getElementById('cancel-date-btn');
        const saveDateBtn = document.getElementById('save-date-btn');
        // Modal inputs
        const editTaskInput = document.getElementById('edit-task-input');
        const dueDateInput = document.getElementById('due-date-input');

        let tasksCollection;
        let unsubscribe;
        let taskToDeleteId = null;
        let taskToEditId = null;
        let taskToSetDateId = null;
        let allTasks = []; // To hold the current state of tasks

        onAuthStateChanged(auth, user => {
            if (user) {
                userInfo.textContent = `ID: ${user.uid.substring(0, 8)}...`;
                const collectionPath = `/artifacts/${appId}/users/${user.uid}/kanban_tasks_priority`;
                tasksCollection = collection(db, collectionPath);
                listenForTasks();
            } else {
                if (unsubscribe) unsubscribe();
                userInfo.textContent = 'กำลังเชื่อมต่อ...';
                loader.style.display = 'flex';
                kanbanBoard.classList.add('hidden');
                signIn();
            }
        });

        async function signIn() {
            try {
                await signInAnonymously(auth);
            } catch (error) { 
                console.error("Error signing in:", error); 
                userInfo.textContent = 'การเชื่อมต่อล้มเหลว'; 
            }
        }

        function listenForTasks() {
            const q = query(tasksCollection);
            unsubscribe = onSnapshot(q, (snapshot) => {
                let tasks = [];
                snapshot.forEach(doc => tasks.push({ id: doc.id, ...doc.data() }));
                tasks.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                allTasks = tasks; // Store tasks globally
                renderTasks(tasks);
            }, (error) => console.error("Error listening for tasks:", error));
        }

        function renderTasks(tasks) {
            taskLists.forEach(list => list.innerHTML = '');
            let taskCounter = 1;
            tasks.forEach(task => {
                const column = document.querySelector(`.kanban-column[data-status="${task.status}"]`);
                if (column) {
                    const taskList = column.querySelector('.task-list');
                    const li = document.createElement('li');
                    li.className = 'task-card bg-gray-50 dark:bg-gray-800 p-3 pl-4 rounded-lg shadow-sm transition-all duration-300 relative group cursor-pointer active:cursor-grabbing';
                    li.classList.add(`priority-${task.priority || 'medium'}`);
                    li.dataset.id = task.id;
                    li.draggable = true;

                    if (task.status === 'done') {
                        li.classList.add('is-done');
                    }

                    const dueDateHTML = task.dueDate ? `
                        <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                            <button class="date-display-btn flex items-center hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                                <i data-lucide="clock" class="h-3 w-3 mr-1.5 pointer-events-none"></i>
                                <span class="pointer-events-none">${formatFirestoreTimestamp(task.dueDate)}</span>
                            </button>
                            <button class="remove-date-btn p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 opacity-0 group-hover:opacity-100 transition-opacity" title="ลบเวลา">
                                <i data-lucide="calendar-x" class="h-3.5 w-3.5 text-red-500 pointer-events-none"></i>
                            </button>
                        </div>
                    ` : `
                        <button class="set-date-btn flex items-center text-xs text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                            <i data-lucide="calendar-plus" class="h-3.5 w-3.5 mr-1.5 pointer-events-none"></i>
                            <span>กำหนดวันที่</span>
                        </button>
                    `;

                    li.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <p class="task-text text-gray-800 dark:text-gray-200 break-words pr-8">${escapeHTML(task.text)}</p>
                            <span class="text-xs font-bold text-gray-400 dark:text-gray-500">#${taskCounter}</span>
                        </div>
                        <div class="task-footer mt-2">
                            ${dueDateHTML}
                        </div>
                        <button class="delete-btn absolute top-1 right-1 text-gray-400 hover:text-red-500 p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" title="ลบงาน">
                            <i data-lucide="trash-2" class="h-4 w-4 pointer-events-none"></i>
                        </button>
                    `;
                    taskList.appendChild(li);
                }
                taskCounter++;
            });
            loader.style.display = 'none';
            kanbanBoard.classList.remove('hidden');
            lucide.createIcons();
        }

        taskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const taskText = taskInput.value.trim();
            if (taskText !== '' && tasksCollection) {
                taskInput.disabled = true;
                try {
                    await addDoc(tasksCollection, {
                        text: taskText,
                        status: 'todo',
                        priority: 'low',
                        createdAt: serverTimestamp(),
                        dueDate: null
                    });
                    taskInput.value = '';
                } catch (error) {
                    console.error("Error adding task: ", error);
                } finally {
                    taskInput.disabled = false;
                    taskInput.focus();
                }
            }
        });

        let draggedCard = null;
        kanbanBoard.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('task-card') && e.target.draggable) {
                draggedCard = e.target;
                e.dataTransfer.setData('text/plain', draggedCard.dataset.id);
                setTimeout(() => { draggedCard.classList.add('dragging'); }, 0);
            }
        });
        kanbanBoard.addEventListener('dragend', () => { if (draggedCard) { draggedCard.classList.remove('dragging'); draggedCard = null; } });
        columns.forEach(column => {
            column.addEventListener('dragover', (e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); });
            column.addEventListener('dragleave', (e) => { e.currentTarget.classList.remove('drag-over'); });
            column.addEventListener('drop', async (e) => {
                e.preventDefault(); e.currentTarget.classList.remove('drag-over');
                const taskId = e.dataTransfer.getData('text/plain');
                const newStatus = e.currentTarget.dataset.status;
                if (taskId && newStatus) {
                    const taskDocRef = doc(db, tasksCollection.path, taskId);
                    try { await updateDoc(taskDocRef, { status: newStatus }); }
                    catch (error) { console.error("Error updating task status: ", error); }
                }
            });
        });

        kanbanBoard.addEventListener('click', (e) => {
            const card = e.target.closest('.task-card');
            if (!card) return;

            const taskId = card.dataset.id;
            const taskData = allTasks.find(t => t.id === taskId);
            if (!taskData) return;

            if (e.target.closest('.delete-btn')) {
                taskToDeleteId = taskId;
                deleteModal.classList.remove('hidden');
            } else if (e.target.closest('.set-date-btn') || e.target.closest('.date-display-btn')) {
                taskToSetDateId = taskId;
                dueDateInput.value = taskData.dueDate ? formatDateForInput(taskData.dueDate) : formatDateForInput(Timestamp.now());
                dateModal.classList.remove('hidden');
            } else if (e.target.closest('.remove-date-btn')) {
                const taskDocRef = doc(db, tasksCollection.path, taskId);
                updateDoc(taskDocRef, { dueDate: null });
            } else {
                taskToEditId = taskId;
                editTaskInput.value = taskData.text;
                document.querySelectorAll('input[name="edit-priority"]').forEach(radio => radio.checked = false);
                const priorityRadio = document.getElementById(`edit-priority-${taskData.priority || 'medium'}`);
                if (priorityRadio) priorityRadio.checked = true;
                editModal.classList.remove('hidden');
            }
            lucide.createIcons();
        });

        function closeModal(modal) {
            modal.classList.add('hidden');
        }

        cancelDeleteBtn.addEventListener('click', () => { closeModal(deleteModal); taskToDeleteId = null; });
        confirmDeleteBtn.addEventListener('click', () => {
            if (taskToDeleteId) {
                const taskDocRef = doc(db, tasksCollection.path, taskToDeleteId);
                deleteDoc(taskDocRef).catch(error => console.error("Error deleting task:", error));
            }
            closeModal(deleteModal);
            taskToDeleteId = null;
        });

        cancelEditBtn.addEventListener('click', () => { closeModal(editModal); taskToEditId = null; });
        saveEditBtn.addEventListener('click', async () => {
            const newText = editTaskInput.value.trim();
            const newPriorityRadio = document.querySelector('input[name="edit-priority"]:checked');
            if (!newText || !newPriorityRadio || !taskToEditId) return;

            const taskDocRef = doc(db, tasksCollection.path, taskToEditId);
            try { await updateDoc(taskDocRef, { text: newText, priority: newPriorityRadio.value }); }
            catch (error) { console.error("Error updating task:", error); }
            finally { closeModal(editModal); taskToEditId = null; }
        });

        cancelDateBtn.addEventListener('click', () => { closeModal(dateModal); taskToSetDateId = null; });
        saveDateBtn.addEventListener('click', async () => {
            const dateValue = dueDateInput.value;
            if (!dateValue || !taskToSetDateId) return;

            const taskDocRef = doc(db, tasksCollection.path, taskToSetDateId);
            try {
                const jsDate = new Date(dateValue);
                const firestoreTimestamp = Timestamp.fromDate(jsDate);
                await updateDoc(taskDocRef, { dueDate: firestoreTimestamp });
            } catch (error) {
                console.error("Error updating due date:", error);
            } finally {
                closeModal(dateModal);
                taskToSetDateId = null;
            }
        });

        function escapeHTML(str) {
            const p = document.createElement('p');
            p.textContent = str;
            return p.innerHTML;
        }

        function formatFirestoreTimestamp(timestamp) {
            if (!timestamp || !timestamp.toDate) return '';
            const date = timestamp.toDate();
            return new Intl.DateTimeFormat('th-TH', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }).format(date);
        }

        function formatDateForInput(timestamp) {
            if (!timestamp || !timestamp.toDate) return '';
            const date = timestamp.toDate();
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            return date.toISOString().slice(0, 16);
        }

        lucide.createIcons();
    </script>
</body>

</html>

